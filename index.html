<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSONäººç‰©å±æ€§ç¼–è¾‘å™¨</title>
    <link rel="stylesheet" type="text/css" href="main.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>å¦¹å±…å­˜æ¡£ç¼–è¾‘å™¨</h1>
            <p class="description">é€‰æ‹©å­˜æ¡£æ–‡ä»¶åï¼Œå³å¯ç¼–è¾‘ç›¸åº”äººè®¾ä¿¡æ¯</p>
        </header>

        <div class="main-content">
            <div class="file-input-section">
                <label for="fileInput" class="file-input-label">é€‰æ‹©JSONå­˜æ¡£æ–‡ä»¶</label>
                <div class="file-name" id="fileName">æœªé€‰æ‹©æ–‡ä»¶</div>
            </div>
            <input type="file" id="fileInput" accept="application/json">

            <div class="selector-section" id="selectorSection" style="display: none;">
                <label for="personSelector" class="selector-label">é€‰æ‹©äººè®¾ï¼š</label>
                <select id="personSelector" class="person-selector">
                    <option value="">-- è¯·é€‰æ‹©ä¸€ä¸ªäººè®¾ --</option>
                </select>
            </div>

            <div id="editorContainer">
                <div class="empty-state" id="emptyState">
                    <div>ğŸ“</div>
                    <p>è¯·é€‰æ‹©ä¸€ä¸ªJSONå­˜æ¡£æ–‡ä»¶å¼€å§‹ç¼–è¾‘</p>
                </div>

                <div class="editor-sections" id="editorSections">
                    <div class="editor-section" id="editorSection" style="display: none;">
                        <div class="section-heading" id="sectionHeading">äººç‰©å±æ€§</div>
                        <div class="properties-container" id="propertiesContainer">
                            <!-- å±æ€§ç¼–è¾‘åŒºåŸŸå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-section">
                <button id="saveButton" disabled>ä¿å­˜æ–‡ä»¶</button>
                <button id="resetButton" disabled>é‡ç½®å†…å®¹</button>
            </div>

            <div id="statusMessage" class="status-message"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // å¸¸é‡éƒ¨åˆ†
            const translation = new Map([
                ['sister-dilei', 'åœ°é›·å¦¹'],
                ['sister-high', 'é«˜å¥½æ„Ÿåº¦(70+)'],
                ['sister-low', 'ä½å¥½æ„Ÿåº¦(-30~30)'],
                ['sister-medium', 'æ™®é€šå¥½æ„Ÿåº¦(30~70)'],
                ['sister-null', 'ç—…å¨‡'],
                ['sister-verylow', 'æ¯’èˆŒ'],

                ['name', 'å§“å'],
                ['description', 'æè¿°'],
                ['personality', 'æ€§æ ¼'],
                ['first_mes', 'åˆæ¬¡å¯¹è¯'],
                ['mes_example', 'å¯¹è¯ç¤ºä¾‹'],
                ['scenario', 'åœºæ™¯'],
                ['creator_notes', 'åˆ›ä½œè€…å¤‡æ³¨'],
                ['tags', 'æ ‡ç­¾']
            ]);
            const fileInput = document.getElementById('fileInput');             // æ–‡ä»¶è¾“å…¥å…ƒç´ 
            const fileNameDisplay = document.getElementById('fileName');       // æ–‡ä»¶åæ˜¾ç¤ºå…ƒç´ 
            const personSelector = document.getElementById('personSelector');   // äººè®¾é€‰æ‹©å™¨
            const editorSections = document.getElementById('editorSections');   // ç¼–è¾‘åŒºåŸŸå®¹å™¨
            const editorSection = {};   // ç¼–è¾‘åŒºåŸŸå…ƒç´ ç»„

            let saveObj = null;   // å­˜æ¡£å¯¹è±¡
            let saveObj_original = null; // åŸå§‹å­˜æ¡£å¯¹è±¡å¤‡ä»½

            // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
            function showStatusMessage(message, type) {
                const statusMessage = document.getElementById('statusMessage');
                statusMessage.textContent = message;
                statusMessage.className = 'status-message ' + type;
                statusMessage.style.display = 'block';

                // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
                if (type === 'success') {
                    setTimeout(hideStatusMessage, 3000);
                }
            }

            // éšè—çŠ¶æ€æ¶ˆæ¯
            function hideStatusMessage() {
                const statusMessage = document.getElementById('statusMessage');
                statusMessage.style.display = 'none';
            }

            // å¡«å……ä¸‹æ‹‰æ¡†é€‰æ‹©å™¨
            const populatePersonSelector = (saveObj) => {
                const personSelector = document.getElementById('personSelector');
                const selectorSection = document.getElementById('selectorSection');
                // æ¸…ç©ºé€‰æ‹©å™¨
                personSelector.innerHTML = '<option id="tempOption" value="">-- è¯·é€‰æ‹©ä¸€ä¸ªäººè®¾è¿›è¡Œç¼–è¾‘ --</option>';

                // æ·»åŠ é€‰é¡¹åŠç¼–è¾‘åˆ—è¡¨
                Object.keys(saveObj.data.prompts).forEach(prompt => {
                    // åˆ›å»ºæ·»åŠ é€‰é¡¹
                    const option = document.createElement('option');
                    option.value = translation.get(prompt) || prompt;
                    option.textContent = option.value;
                    personSelector.appendChild(option);
                    selectorSection.style.display = 'block';
                    // åˆ›å»ºæ·»åŠ ç¼–è¾‘åŒºåŸŸç»„å®¹å™¨(å…ˆéšè—)
                    editorSection[prompt] = {};
                    editorSection[prompt]['mainContainer'] = document.createElement('div');
                    editorSection[prompt]['mainContainer'].className = 'editor-section';
                    editorSection[prompt]['mainContainer'].style.display = 'none';
                    editorSections.appendChild(editorSection[prompt]['mainContainer']);

                    const sectionHeading = document.createElement('div');
                    sectionHeading.className = 'section-heading';
                    sectionHeading.textContent = translation.get(prompt) || prompt;
                    editorSection[prompt]['mainContainer'].appendChild(sectionHeading);

                    const propertiesContainer = document.createElement('div');
                    propertiesContainer.className = 'properties-container';
                    editorSection[prompt]['mainContainer'].appendChild(propertiesContainer);

                    editorSection[prompt].propertyLabels = {};
                    editorSection[prompt].propertyInputs = {};
                    Object.keys(saveObj.data.prompts[prompt].data).forEach(attr => {
                        if (typeof saveObj.data.prompts[prompt].data[attr] !== 'string') {
                            return;
                        }
                        // åˆ›å»ºå±æ€§ç¼–è¾‘ç»„
                        const propertyGroup = document.createElement('div');
                        propertyGroup.className = 'property-group';
                        propertiesContainer.appendChild(propertyGroup);

                        const propertyInput = document.createElement('textarea');
                        editorSection[prompt].propertyInputs[attr] = propertyInput;
                        propertyInput.className = 'property-input';
                        propertyInput.id = `${prompt}-${attr}`;
                        propertyInput.value = saveObj.data.prompts[prompt].data[attr];
                        
                        editorSection[prompt].propertyLabels[attr] = document.createElement('label');
                        editorSection[prompt].propertyLabels[attr].className = 'property-label';
                        editorSection[prompt].propertyLabels[attr].htmlFor = propertyInput.id;
                        editorSection[prompt].propertyLabels[attr].textContent = translation.get(attr) || attr;

                        propertyGroup.appendChild(editorSection[prompt].propertyLabels[attr]);
                        propertyGroup.appendChild(propertyInput);
                    });
                });
            }

            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    fileNameDisplay.textContent = file.name;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // è¯»å–æ–‡ä»¶åæ“ä½œ
                        try {
                            saveObj = JSON.parse(e.target.result);
                            saveObj_original = JSON.parse(e.target.result);
                            populatePersonSelector(saveObj);
                            console.log(saveObj);
                            const emptyState = document.getElementById('emptyState');
                            emptyState.style.display = 'none';
                            const saveButton = document.getElementById('saveButton');
                            saveButton.disabled = false;
                            const resetButton = document.getElementById('resetButton');
                            resetButton.disabled = false;
                            showStatusMessage('æ–‡ä»¶è¯»å–æˆåŠŸ','success');
                        } catch (error) {
                            showStatusMessage('JSONæ–‡ä»¶æ ¼å¼é”™è¯¯: ' + error.message, 'error');
                            console.error(error);
                        }

                    };

                    reader.onerror = function () {
                        showStatusMessage('è¯»å–æ–‡ä»¶æ—¶å‡ºé”™', 'error');
                    };

                    reader.readAsText(file);
                }
            });

            // é€‰æ‹©äººè®¾äº‹ä»¶
            personSelector.addEventListener('change', (event) => {
                const tempOption = document.getElementById('tempOption');
                if (tempOption) {
                    tempOption.remove();
                }
                console.log(personSelector.value);
                for (let [key, value] of translation) {
                    if (personSelector.value !== value) {
                        continue;
                    }
                    for (const prompt in editorSection) {
                        if (key === prompt) {
                            editorSection[prompt]['mainContainer'].style.display = 'block';
                        } else {
                            editorSection[prompt]['mainContainer'].style.display = 'none';
                        }
                    }
                    
                }
            });

            // ä¿å­˜æ–‡ä»¶äº‹ä»¶
            const saveButton = document.getElementById('saveButton');
            saveButton.addEventListener('click', () => {
                if (!saveObj) {
                    showStatusMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                    return;
                }

                try {
                    for (const prompt in editorSection) {
                        for (const attr in editorSection[prompt].propertyInputs) {
                            saveObj.data.prompts[prompt].data[attr] = editorSection[prompt].propertyInputs[attr].value;
                        }
                    }

                    const content = JSON.stringify(saveObj, null, 2);
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // ç”Ÿæˆæ–°æ–‡ä»¶åï¼šåŸæ–‡ä»¶å + "_edited"
                    const originalName = fileNameDisplay.textContent;
                    const dotIndex = originalName.lastIndexOf('.');
                    let newName;
                    
                    if (dotIndex > 0) {
                        newName = originalName.substring(0, dotIndex) + '_edited' + originalName.substring(dotIndex);
                    } else {
                        newName = originalName + '_edited';
                    }
                    
                    a.download = newName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showStatusMessage('æ–‡ä»¶ä¿å­˜æˆåŠŸï¼', 'success');
                } catch (error) {
                    showStatusMessage('ä¿å­˜æ–‡ä»¶æ—¶å‡ºé”™: ' + error.message, 'error');
                }
            });



        });
    </script>
</body>

</html>